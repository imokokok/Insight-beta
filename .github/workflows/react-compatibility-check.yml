name: React 19 Compatibility Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # æ¯å‘¨ä¸€è¿è¡Œ
    - cron: '0 0 * * 1'
  workflow_dispatch:

jobs:
  compatibility-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check React version
        id: react-version
        run: |
          REACT_VERSION=$(node -p "require('./package.json').dependencies.react")
          echo "React version: $REACT_VERSION"
          echo "version=$REACT_VERSION" >> $GITHUB_OUTPUT

      - name: Check Next.js version
        id: next-version
        run: |
          NEXT_VERSION=$(node -p "require('./package.json').dependencies.next")
          echo "Next.js version: $NEXT_VERSION"
          echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT

      - name: TypeScript type check
        run: npm run typecheck

      - name: ESLint check
        run: npm run lint

      - name: Run tests
        run: npm run test:ci

      - name: Build check
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check for deprecated React APIs
        run: |
          echo "Checking for deprecated React APIs..."
          
          # æ£€æŸ¥ React.PropTypes
          if grep -r "React\.PropTypes" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "âš ï¸  Found React.PropTypes usage (deprecated in React 19)"
          fi
          
          # æ£€æŸ¥ ReactDOM.render
          if grep -r "ReactDOM\.render" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "âš ï¸  Found ReactDOM.render usage (deprecated in React 19)"
          fi
          
          # æ£€æŸ¥ defaultProps
          if grep -r "defaultProps" src/ --include="*.ts" --include="*.tsx" 2>/dev/null; then
            echo "âš ï¸  Found defaultProps usage (deprecated in React 19)"
          fi
          
          echo "âœ… Deprecated API check complete"

      - name: Check dependency compatibility
        run: |
          echo "Checking dependency compatibility..."
          
          # æ£€æŸ¥ peer dependencies
          npm ls react react-dom --depth=0 || true
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å†²çªçš„ React ç‰ˆæœ¬
          if npm ls react 2>&1 | grep -q "invalid"; then
            echo "âŒ Found conflicting React versions"
            exit 1
          fi
          
          echo "âœ… Dependency compatibility check complete"

      - name: Generate compatibility report
        if: always()
        run: |
          cat > react-compatibility-report.md << 'EOF'
          # React 19 å…¼å®¹æ€§æ£€æŸ¥æŠ¥å‘Š

          **æ£€æŸ¥æ—¶é—´**: ${{ github.event.head_commit.timestamp || github.event.schedule }}
          **å·¥ä½œæµè¿è¡Œ**: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## ç‰ˆæœ¬ä¿¡æ¯

          - **React**: ${{ steps.react-version.outputs.version }}
          - **Next.js**: ${{ steps.next-version.outputs.version }}

          ## æ£€æŸ¥ç»“æžœ

          | æ£€æŸ¥é¡¹ | çŠ¶æ€ |
          |--------|------|
          | TypeScript ç±»åž‹æ£€æŸ¥ | ${{ job.status == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | ESLint æ£€æŸ¥ | ${{ job.status == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | å•å…ƒæµ‹è¯• | ${{ job.status == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |
          | æž„å»ºæµ‹è¯• | ${{ job.status == 'success' && 'âœ… é€šè¿‡' || 'âŒ å¤±è´¥' }} |

          ## å·²çŸ¥é—®é¢˜

          å½“å‰é¡¹ç›®å­˜åœ¨ä¸€äº›éžç©ºæ–­è¨€è­¦å‘Šï¼ˆ`!` æ“ä½œç¬¦ï¼‰ï¼Œè¿™äº›ä¸æ˜¯ React 19 å¼•å…¥çš„é—®é¢˜ï¼Œå»ºè®®é€æ­¥ä¿®å¤ã€‚

          ## å»ºè®®

          1. å®šæœŸè¿è¡Œ `npm outdated` æ£€æŸ¥ä¾èµ–æ›´æ–°
          2. å…³æ³¨ React 19 å®˜æ–¹å‘å¸ƒè¯´æ˜Ž
          3. åœ¨å¼€å‘çŽ¯å¢ƒä¸­å¯ç”¨ä¸¥æ ¼æ¨¡å¼
          4. é€æ­¥ä¿®å¤éžç©ºæ–­è¨€è­¦å‘Š

          ---
          *æ­¤æŠ¥å‘Šç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*
          EOF

          cat react-compatibility-report.md

      - name: Upload compatibility report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: react-compatibility-report
          path: react-compatibility-report.md

      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ðŸš¨ React 19 å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥ - ${new Date().toISOString().split('T')[0]}`;
            const body = `## React 19 å…¼å®¹æ€§æ£€æŸ¥å¤±è´¥

          å·¥ä½œæµè¿è¡Œ: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ### å¤±è´¥ä¿¡æ¯

          è¯·æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—èŽ·å–è¯¦ç»†ä¿¡æ¯ã€‚

          ### å¯èƒ½çš„åŽŸå› 

          1. TypeScript ç±»åž‹é”™è¯¯
          2. ESLint é”™è¯¯
          3. æµ‹è¯•å¤±è´¥
          4. æž„å»ºå¤±è´¥
          5. ä¾èµ–å†²çª

          ### å»ºè®®æ“ä½œ

          1. æŸ¥çœ‹å·¥ä½œæµæ—¥å¿—
          2. åœ¨æœ¬åœ°è¿è¡Œç›¸åŒçš„æ£€æŸ¥
          3. ä¿®å¤é—®é¢˜åŽé‡æ–°è¿è¡Œå·¥ä½œæµ

          ---
          *æ­¤ Issue ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ*`;

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['bug', 'react-19', 'compatibility']
            });
