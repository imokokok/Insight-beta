// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// 价格历史数据模型
// ============================================================================

model PriceHistoryRaw {
  id          BigInt   @id @default(autoincrement())
  symbol      String   @db.VarChar(50)
  protocol    String   @db.VarChar(50)
  chain       String   @db.VarChar(50)
  price       Decimal  @db.Decimal(36, 18)
  priceRaw    String   @map("price_raw") @db.VarChar(78)
  decimals    Int      @default(8)
  timestamp   DateTime @db.Timestamptz()
  blockNumber BigInt?  @map("block_number")
  confidence  Decimal? @db.Decimal(5, 4)
  volume24h   Decimal? @map("volume_24h") @db.Decimal(36, 18)
  change24h   Decimal? @map("change_24h") @db.Decimal(10, 4)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([symbol, timestamp(sort: Desc)])
  @@index([protocol, timestamp(sort: Desc)])
  @@index([chain, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@index([symbol, protocol, chain, timestamp(sort: Desc)])
  // 复合索引优化常用查询
  @@index([protocol, chain, timestamp(sort: Desc)])
  @@index([symbol, protocol, timestamp(sort: Desc)])
  @@map("price_history_raw")
}

model PriceHistoryMin1 {
  id          BigInt   @id @default(autoincrement())
  symbol      String   @db.VarChar(50)
  protocol    String   @db.VarChar(50)
  chain       String   @db.VarChar(50)
  priceOpen   Decimal  @map("price_open") @db.Decimal(36, 18)
  priceHigh   Decimal  @map("price_high") @db.Decimal(36, 18)
  priceLow    Decimal  @map("price_low") @db.Decimal(36, 18)
  priceClose  Decimal  @map("price_close") @db.Decimal(36, 18)
  volume      BigInt   @default(0)
  timestamp   DateTime @db.Timestamptz()
  sampleCount Int      @default(0) @map("sample_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@unique([symbol, protocol, chain, timestamp])
  @@index([symbol, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("price_history_min1")
}

model PriceHistoryMin5 {
  id          BigInt   @id @default(autoincrement())
  symbol      String   @db.VarChar(50)
  protocol    String   @db.VarChar(50)
  chain       String   @db.VarChar(50)
  priceOpen   Decimal  @map("price_open") @db.Decimal(36, 18)
  priceHigh   Decimal  @map("price_high") @db.Decimal(36, 18)
  priceLow    Decimal  @map("price_low") @db.Decimal(36, 18)
  priceClose  Decimal  @map("price_close") @db.Decimal(36, 18)
  volume      BigInt   @default(0)
  timestamp   DateTime @db.Timestamptz()
  sampleCount Int      @default(0) @map("sample_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@unique([symbol, protocol, chain, timestamp])
  @@index([symbol, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("price_history_min5")
}

model PriceHistoryHour1 {
  id          BigInt   @id @default(autoincrement())
  symbol      String   @db.VarChar(50)
  protocol    String   @db.VarChar(50)
  chain       String   @db.VarChar(50)
  priceOpen   Decimal  @map("price_open") @db.Decimal(36, 18)
  priceHigh   Decimal  @map("price_high") @db.Decimal(36, 18)
  priceLow    Decimal  @map("price_low") @db.Decimal(36, 18)
  priceClose  Decimal  @map("price_close") @db.Decimal(36, 18)
  volume      BigInt   @default(0)
  timestamp   DateTime @db.Timestamptz()
  sampleCount Int      @default(0) @map("sample_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@unique([symbol, protocol, chain, timestamp])
  @@index([symbol, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("price_history_hour1")
}

model PriceHistoryDay1 {
  id          BigInt   @id @default(autoincrement())
  symbol      String   @db.VarChar(50)
  protocol    String   @db.VarChar(50)
  chain       String   @db.VarChar(50)
  priceOpen   Decimal  @map("price_open") @db.Decimal(36, 18)
  priceHigh   Decimal  @map("price_high") @db.Decimal(36, 18)
  priceLow    Decimal  @map("price_low") @db.Decimal(36, 18)
  priceClose  Decimal  @map("price_close") @db.Decimal(36, 18)
  volume      BigInt   @default(0)
  timestamp   DateTime @db.Timestamptz()
  sampleCount Int      @default(0) @map("sample_count")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@unique([symbol, protocol, chain, timestamp])
  @@index([symbol, timestamp(sort: Desc)])
  @@index([timestamp(sort: Desc)])
  @@map("price_history_day1")
}

// ============================================================================
// Solana 数据模型
// ============================================================================

model SolanaPriceFeed {
  id          String   @id @default(uuid())
  symbol      String   @db.VarChar(50)
  name        String   @db.VarChar(100)
  price       Decimal  @db.Decimal(36, 18)
  confidence  Decimal  @db.Decimal(5, 4)
  timestamp   DateTime @db.Timestamptz()
  slot        BigInt
  signature   String   @db.VarChar(100)
  source      String   @db.VarChar(50)
  status      String   @default("active") @db.VarChar(20)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  histories SolanaPriceHistory[]

  @@index([symbol])
  @@index([timestamp(sort: Desc)])
  @@index([status])
  @@map("solana_price_feeds")
}

model SolanaPriceHistory {
  id        String   @id @default(uuid())
  feedId    String   @map("feed_id")
  price     Decimal  @db.Decimal(36, 18)
  confidence Decimal @db.Decimal(5, 4)
  timestamp DateTime @db.Timestamptz()
  slot      BigInt
  signature String   @db.VarChar(100)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz()

  feed SolanaPriceFeed @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@index([feedId, timestamp(sort: Desc)])
  @@map("solana_price_histories")
}

model SolanaOracleInstance {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)
  programId   String   @map("program_id") @db.VarChar(50)
  cluster     String   @db.VarChar(20)
  rpcUrl      String   @map("rpc_url") @db.VarChar(200)
  isActive    Boolean  @default(true) @map("is_active")
  lastSyncAt  DateTime? @map("last_sync_at") @db.Timestamptz()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@map("solana_oracle_instances")
}

model SolanaSyncStatus {
  id            String   @id @default(uuid())
  instanceId    String   @map("instance_id")
  feedSymbol    String   @map("feed_symbol") @db.VarChar(50)
  lastSlot      BigInt   @map("last_slot")
  lastSignature String   @map("last_signature") @db.VarChar(100)
  lastTimestamp DateTime @map("last_timestamp") @db.Timestamptz()
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz()

  @@unique([instanceId, feedSymbol])
  @@map("solana_sync_status")
}

model SolanaAlert {
  id          String   @id @default(uuid())
  type        String   @db.VarChar(50)
  severity    String   @db.VarChar(20)
  symbol      String   @db.VarChar(50)
  message     String   @db.Text
  details     Json?
  status      String   @default("active") @db.VarChar(20)
  resolvedAt  DateTime? @map("resolved_at") @db.Timestamptz()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()

  @@index([symbol, status])
  @@index([severity, status])
  @@index([createdAt(sort: Desc)])
  @@map("solana_alerts")
}

// ============================================================================
// SLO (Service Level Objective) 数据模型
// ============================================================================

model SloDefinition {
  id          String   @id @default(uuid())
  name        String   @db.VarChar(100)
  description String?  @db.Text
  protocol    String   @db.VarChar(50)
  chain       String   @db.VarChar(50)
  metricType  String   @map("metric_type") @db.VarChar(50) // latency, availability, accuracy, custom
  
  // SLO 目标定义
  targetValue     Decimal  @map("target_value") @db.Decimal(10, 4) // 目标值，如 99.9
  thresholdValue  Decimal  @map("threshold_value") @db.Decimal(10, 4) // 阈值，如 95.0
  evaluationWindow String @map("evaluation_window") @db.VarChar(20) // 30d, 7d, 24h
  
  // Error Budget 设置
  errorBudgetPolicy String @map("error_budget_policy") @db.VarChar(20) @default("monthly") // monthly, weekly, daily
  
  // 条件定义（JSON 格式存储复杂条件）
  conditionConfig Json? @map("condition_config")
  
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz()
  
  // 关联
  metrics     SloMetric[]
  errorBudgets ErrorBudget[]
  
  @@index([protocol, chain])
  @@index([metricType])
  @@index([isActive])
  @@map("slo_definitions")
}

model SloMetric {
  id          String   @id @default(uuid())
  sloId       String   @map("slo_id")
  
  // 实际指标值
  actualValue   Decimal  @map("actual_value") @db.Decimal(10, 4)
  targetValue   Decimal  @map("target_value") @db.Decimal(10, 4)
  
  // 合规状态
  isCompliant   Boolean  @default(true) @map("is_compliant")
  complianceRate Decimal  @map("compliance_rate") @db.Decimal(5, 2) // 0-100
  
  // 统计信息
  totalEvents   Int      @default(0) @map("total_events")
  goodEvents    Int      @default(0) @map("good_events")
  badEvents     Int      @default(0) @map("bad_events")
  
  // 时间窗口
  windowStart   DateTime @map("window_start") @db.Timestamptz()
  windowEnd     DateTime @map("window_end") @db.Timestamptz()
  
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz()
  
  // 关联
  slo           SloDefinition @relation(fields: [sloId], references: [id], onDelete: Cascade)
  
  @@index([sloId, windowStart])
  @@index([windowEnd])
  @@map("slo_metrics")
}

model ErrorBudget {
  id          String   @id @default(uuid())
  sloId       String   @map("slo_id")
  
  // 预算周期
  periodStart   DateTime @map("period_start") @db.Timestamptz()
  periodEnd     DateTime @map("period_end") @db.Timestamptz()
  
  // Error Budget 计算
  totalBudget   Decimal  @map("total_budget") @db.Decimal(20, 8) // 总预算（时间或事件数）
  usedBudget    Decimal  @map("used_budget") @db.Decimal(20, 8) // 已使用预算
  remainingBudget Decimal @map("remaining_budget") @db.Decimal(20, 8) // 剩余预算
  
  // 状态
  burnRate      Decimal  @map("burn_rate") @db.Decimal(10, 4) // 消耗速率（每天）
  projectedDepletion DateTime? @map("projected_depletion") @db.Timestamptz() // 预计耗尽时间
  
  status        String   @default("healthy") @db.VarChar(20) // healthy, at_risk, exhausted
  
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz()
  updatedAt     DateTime @updatedAt @map("updated_at") @db.Timestamptz()
  
  // 关联
  slo           SloDefinition @relation(fields: [sloId], references: [id], onDelete: Cascade)
  
  @@index([sloId, periodStart])
  @@index([status])
  @@map("error_budgets")
}

// ============================================================================
// 事件时间线数据模型
// ============================================================================

model EventTimeline {
  id          String   @id @default(uuid())
  
  // 事件基本信息
  eventType   String   @map("event_type") @db.VarChar(50) // alert_triggered, dispute_created, fix_completed, config_changed, deployment, price_spike
  severity    String   @default("info") @db.VarChar(20) // info, warning, error, critical
  title       String   @db.VarChar(200)
  description String?  @db.Text
  
  // 关联信息
  protocol    String?  @db.VarChar(50)
  chain       String?  @db.VarChar(50)
  symbol      String?  @db.VarChar(50)
  entityType  String?  @map("entity_type") @db.VarChar(50) // alert, dispute, assertion, config
  entityId    String?  @map("entity_id") @db.VarChar(100)
  
  // 事件详情（JSON 格式）
  metadata    Json?
  
  // 时间信息
  occurredAt  DateTime @map("occurred_at") @db.Timestamptz()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  
  // 关联关系（支持事件链）
  parentEventId String? @map("parent_event_id")
  relatedEventIds String[] @map("related_event_ids") // PostgreSQL 数组类型
  
  // 来源
  source      String   @default("system") @db.VarChar(50) // system, user, api, webhook
  sourceUser  String?  @map("source_user") @db.VarChar(100)
  
  @@index([eventType, occurredAt(sort: Desc)])
  @@index([protocol, chain, occurredAt(sort: Desc)])
  @@index([symbol, occurredAt(sort: Desc)])
  @@index([entityType, entityId])
  @@index([severity, occurredAt(sort: Desc)])
  @@index([occurredAt(sort: Desc)])
  @@map("event_timeline")
}

// ============================================================================
// 部署记录表（用于事件时间线）
// ============================================================================

model DeploymentRecord {
  id          String   @id @default(uuid())
  
  // 部署信息
  version     String   @db.VarChar(50)
  environment String   @db.VarChar(50) // production, staging, development
  commitHash  String?  @map("commit_hash") @db.VarChar(100)
  branch      String?  @db.VarChar(100)
  
  // 变更内容
  changes     Json?    // 变更列表
  affectedServices String[] @map("affected_services") // 影响的服务列表
  
  // 部署状态
  status      String   @default("in_progress") @db.VarChar(20) // in_progress, completed, failed, rolled_back
  deployedBy  String?  @map("deployed_by") @db.VarChar(100)
  
  // 时间
  startedAt   DateTime @map("started_at") @db.Timestamptz()
  completedAt DateTime? @map("completed_at") @db.Timestamptz()
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz()
  
  @@index([environment, startedAt(sort: Desc)])
  @@index([status])
  @@map("deployment_records")
}
