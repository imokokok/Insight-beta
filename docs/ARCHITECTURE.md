# OracleMonitor 架构文档

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Web App   │  │  Mobile App │  │   API 客户端 │  │   第三方集成         │  │
│  │  (Next.js)  │  │  (PWA)      │  │             │  │                     │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼────────────────┼────────────────────┼─────────────┘
          │                │                │                    │
          └────────────────┴────────────────┴────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API 网关层 (API Gateway)                            │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                         Next.js API Routes                             │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │  │
│  │  │  Rate    │ │   Auth   │ │ Validate │ │  Cache   │ │    Audit     │  │  │
│  │  │  Limit   │ │          │ │          │ │          │ │     Log      │  │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          服务层 (Service Layer)                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  Oracle Service │  │  Alert Service  │  │  Audit Service  │              │
│  │                 │  │                 │  │                 │              │
│  │ - Assertions    │  │ - Alert Rules   │  │ - Audit Logs    │              │
│  │ - Disputes      │  │ - Notifications │  │ - Statistics    │              │
│  │ - Sync          │  │ - Webhooks      │  │ - Export        │              │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘              │
│           │                    │                    │                        │
│  ┌────────┴────────┐  ┌────────┴────────┐  ┌────────┴────────┐              │
│  │  UMA Service    │  │  Config Service │  │  User Service   │              │
│  │                 │  │                 │  │                 │              │
│  │ - UMA Protocol  │  │ - Config Mgmt   │  │ - Watchlist     │              │
│  │ - Voting        │  │ - Versioning    │  │ - Preferences   │              │
│  │ - Rewards       │  │ - Templates     │  │ - Stats         │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据层 (Data Layer)                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   PostgreSQL    │  │     Redis       │  │   Blockchain    │              │
│  │                 │  │                 │  │                 │              │
│  │ - Assertions    │  │ - Cache         │  │ - Smart Contracts│             │
│  │ - Disputes      │  │ - Sessions      │  │ - Events        │              │
│  │ - Alerts        │  │ - Rate Limiting │  │ - Transactions  │              │
│  │ - Users         │  │ - Pub/Sub       │  │                 │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心流程

### 1. 断言创建流程

```
用户创建断言
    │
    ▼
┌─────────────────┐
│  前端验证输入    │
│  - 地址格式      │
│  - 金额有效性    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  调用智能合约    │
│  - assertTruth() │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  区块链事件监听  │────▶│  索引器处理      │
│  AssertionMade  │     │  - 解析事件      │
└─────────────────┘     │  - 存储到数据库  │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  触发告警检查    │
                        │  - 规则匹配      │
                        │  - 通知发送      │
                        └─────────────────┘
```

### 2. 争议处理流程

```
用户发起争议
    │
    ▼
┌─────────────────┐
│  验证争议条件    │
│  - 断言状态      │
│  - 争议窗口期    │
│  - 质押金额      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  调用智能合约    │
│  - dispute()     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  区块链事件监听  │────▶│  更新争议状态    │
│  DisputeMade    │     │  - 标记争议      │
└─────────────────┘     │  - 通知相关方    │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  投票阶段开始    │
                        │  - UMA DVM      │
                        │  - 投票奖励计算  │
                        └─────────────────┘
```

### 3. 数据同步流程

```
┌─────────────────┐
│   定时触发器     │
│  (Cron Job)     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  获取最新区块    │
│  - RPC 调用      │
│  - 失败重试      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  扫描事件日志    │
│  - 断言事件      │
│  - 争议事件      │
│  - 投票事件      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  批量处理事件    │────▶│  数据库更新      │
│  - 解析参数      │     │  - 插入新记录    │
│  - 验证数据      │     │  - 更新状态      │
└─────────────────┘     │  - 缓存刷新      │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  发送实时通知    │
                        │  - WebSocket    │
                        │  - Webhook      │
                        └─────────────────┘
```

### 4. 告警处理流程

```
事件触发
    │
    ▼
┌─────────────────┐
│  评估告警规则    │
│  - 条件匹配      │
│  - 严重级别      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  去重检查        │
│  - 相似告警      │
│  - 冷却时间      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  创建告警记录    │
│  - 存储到数据库  │
│  - 更新缓存      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  发送邮件通知    │────▶│  发送 Telegram  │────▶│  发送 Webhook   │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 组件关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端组件架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     Page Components                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │   │
│  │  │  Home   │ │ Oracle  │ │ Disputes│ │     Admin       │ │   │
│  │  │  Page   │ │  Page   │ │  Page   │ │     Page        │ │   │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────────┬────────┘ │   │
│  │       └─────────────┴───────────┴───────────────┘          │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                 Feature Components                   │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │   │
│  │  │  │Assertion │ │  Dispute │ │  Alert   │ │  Chart  │ │  │   │
│  │  │  │  List    │ │  Modal   │ │  Manager │ │         │ │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                   UI Components                      │  │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────────────┐  │  │   │
│  │  │  │ Button │ │  Card  │ │  Input │ │    Modal     │  │  │   │
│  │  │  └────────┘ └────────┘ └────────┘ └──────────────┘  │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                    Custom Hooks                      │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │   │
│  │  │  │useOracle │ │ useAlert │ │useWallet │ │ useUser │ │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │────▶│   Action    │────▶│    Hook     │────▶│   SWR Cache │
│  Interaction│     │   Trigger   │     │   Call      │     │   (Client)  │
└─────────────┘     └─────────────┘     └──────┬──────┘     └──────┬──────┘
                                               │                    │
                                               ▼                    │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐            │
│   UI Update │◀────│  Re-render  │◀────│  Data Fetch │◀───────────┘
│             │     │             │     │   Response  │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  API Route  │
                                        │             │
                                        │ - Rate Limit│
                                        │ - Auth Check│
                                        │ - Validation│
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   Service   │
                                        │   Layer     │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │    Cache    │
                                        │   (Redis)   │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  Database   │
                                        │(PostgreSQL) │
                                        └─────────────┘
```

## 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              生产环境部署架构                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         CDN (Vercel Edge)                           │   │
│  │                     - 静态资源缓存                                  │   │
│  │                     - 边缘计算                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Load Balancer                                  │   │
│  │                   - SSL 终止                                        │   │
│  │                   - 流量分发                                        │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                    ┌───────────────┼───────────────┐                        │
│                    │               │               │                        │
│                    ▼               ▼               ▼                        │
│  ┌─────────────────────┐ ┌─────────────────────┐ ┌─────────────────────┐   │
│  │   Next.js App #1    │ │   Next.js App #2    │ │   Next.js App #3    │   │
│  │                     │ │                     │ │                     │   │
│  │  - API Routes       │ │  - API Routes       │ │  - API Routes       │   │
│  │  - SSR Pages        │ │  - SSR Pages        │ │  - SSR Pages        │   │
│  │  - Static Pages     │ │  - Static Pages     │ │  - Static Pages     │   │
│  └──────────┬──────────┘ └──────────┬──────────┘ └──────────┬──────────┘   │
│             │                       │                       │              │
│             └───────────────────────┼───────────────────────┘              │
│                                     │                                      │
│                                     ▼                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Data Layer                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │   │
│  │  │ PostgreSQL  │  │    Redis    │  │   RPC Pool  │                 │   │
│  │  │  Primary    │  │   Cluster   │  │             │                 │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 安全架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        安全层架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    应用层安全                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │   CSP    │ │   CORS   │ │   CSRF   │ │  XSS     │   │   │
│  │  │  Headers │ │  Config  │ │  Tokens  │ │ Protection│   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    认证授权层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │  Wallet  │ │  Admin   │ │  Session │ │   JWT    │   │   │
│  │  │  Auth    │ │  Token   │ │   Mgmt   │ │  Verify  │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    API 安全层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │  Rate    │ │  Input   │ │  Output  │ │  Audit   │   │   │
│  │  │  Limit   │ │ Validate │ │ Sanitize │ │   Log    │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    数据安全层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │   SQL    │ │   Data   │ │  Backup  │ │  Encrypt │   │   │
│  │  │Injection │ │  Encrypt │ │   Mgmt   │ │  at Rest │   │   │
│  │  │  Protect │ │          │ │          │ │          │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        监控体系                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   应用监控       │  │   性能监控       │  │   业务监控       │  │
│  │                 │  │                 │  │                 │  │
│  │  - Sentry       │  │  - Web Vitals   │  │  - 断言统计      │  │
│  │  - Error Track  │  │  - LCP/FCP/CLS  │  │  - 争议统计      │  │
│  │  - Log Aggregation│ │- API Latency   │  │  - 用户活跃度    │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    告警中心                              │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │  Email   │ │ Telegram │ │  Webhook │ │  PagerDuty│   │   │
│  │  │  Alert   │ │  Alert   │ │  Alert   │ │   Alert   │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 技术栈

| 层级     | 技术                   | 用途                     |
| -------- | ---------------------- | ------------------------ |
| 前端框架 | Next.js 15             | React 框架，支持 SSR/SSG |
| 语言     | TypeScript 5.7         | 类型安全                 |
| 样式     | Tailwind CSS           | 原子化 CSS               |
| UI 组件  | Radix UI + 自定义      | 可访问性组件             |
| 状态管理 | SWR                    | 数据获取和缓存           |
| 区块链   | Viem                   | 与智能合约交互           |
| 后端     | Next.js API Routes     | API 端点                 |
| 数据库   | PostgreSQL             | 主数据库                 |
| 缓存     | Redis                  | 缓存和会话               |
| 测试     | Vitest + Playwright    | 单元测试和 E2E           |
| 监控     | Sentry + OpenTelemetry | 错误追踪和可观测性       |
| 部署     | Vercel                 | 托管和 CI/CD             |

## 扩展性设计

1. **水平扩展**: 无状态设计，支持多实例部署
2. **数据库**: 读写分离，支持连接池
3. **缓存**: 多级缓存策略（客户端 + Redis）
4. **CDN**: 静态资源边缘缓存
5. **微服务**: 服务端逻辑可独立拆分
