# OracleMonitor 架构文档

## 系统架构概览

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              用户层 (User Layer)                              │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Web App   │  │  Mobile App │  │   API 客户端 │  │   第三方集成         │  │
│  │  (Next.js)  │  │  (PWA)      │  │             │  │                     │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼────────────────┼────────────────────┼─────────────┘
          │                │                │                    │
          └────────────────┴────────────────┴────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API 网关层 (API Gateway)                            │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                         Next.js API Routes                             │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │  │
│  │  │  Rate    │ │   Auth   │ │ Validate │ │  Cache   │ │    Audit     │  │  │
│  │  │  Limit   │ │          │ │          │ │          │ │     Log      │  │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          服务层 (Service Layer)                               │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  Unified Oracle │  │  Alert Service  │  │  Audit Service  │              │
│  │    Service      │  │                 │  │                 │              │
│  │                 │  │ - Alert Rules   │  │ - Audit Logs    │              │
│  │ - Multi-Protocol│  │ - Notifications │  │ - Statistics    │              │
│  │   Aggregation   │  │ - Webhooks      │  │ - Export        │              │
│  │ - Price Sync    │  │                 │  │                 │              │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘              │
│           │                    │                    │                        │
│  ┌────────┴────────┐  ┌────────┴────────┐  ┌────────┴────────┐              │
│  │ Protocol Services│  │  Config Service │  │  User Service   │              │
│  │                  │  │                 │  │                 │              │
│  │ - UMA (Assertions│  │ - Config Mgmt   │  │ - Watchlist     │              │
│  │   & Disputes)   │  │ - Versioning    │  │ - Preferences   │              │
│  │ - Chainlink/Pyth│  │ - Templates     │  │ - Stats         │              │
│  │   Price Feeds   │  │                 │  │                 │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          数据层 (Data Layer)                                  │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │   PostgreSQL    │  │     Redis       │  │   Blockchain    │              │
│  │                 │  │                 │  │                 │              │
│  │ - Assertions    │  │ - Cache         │  │ - Smart Contracts│             │
│  │ - Disputes      │  │ - Sessions      │  │ - Events        │              │
│  │ - Alerts        │  │ - Rate Limiting │  │ - Transactions  │              │
│  │ - Users         │  │ - Pub/Sub       │  │                 │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 核心流程

### 1. 价格数据聚合流程

```
┌─────────────────────────────────────────────────────────────┐
│                     多协议价格同步                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  Chainlink  │  │    Pyth     │  │    Band     │         │
│  │    Sync     │  │    Sync     │  │    Sync     │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                │
│         └────────────────┼────────────────┘                │
│                          │                                 │
│                          ▼                                 │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              Unified Price Aggregator                │  │
│  │                                                      │  │
│  │  - 异常值检测 (Outlier Detection)                    │  │
│  │  - 加权平均计算                                      │  │
│  │  - 置信度评分                                        │  │
│  │  - 价格偏差分析                                      │  │
│  └────────────────────────┬────────────────────────────┘  │
│                           │                                │
│                           ▼                                │
│  ┌─────────────────────────────────────────────────────┐  │
│  │              数据分发                                │  │
│  │                                                      │  │
│  │  - WebSocket 实时推送                                │  │
│  │  - REST API 查询                                     │  │
│  │  - 告警触发                                          │  │
│  └─────────────────────────────────────────────────────┘  │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. UMA 断言创建流程 (特定协议)

```
用户创建断言
    │
    ▼
┌─────────────────┐
│  前端验证输入    │
│  - 地址格式      │
│  - 金额有效性    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  调用智能合约    │
│  - assertTruth() │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  区块链事件监听  │────▶│  索引器处理      │
│  AssertionMade  │     │  - 解析事件      │
└─────────────────┘     │  - 存储到数据库  │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  触发告警检查    │
                        │  - 规则匹配      │
                        │  - 通知发送      │
                        └─────────────────┘
```

### 3. UMA 争议处理流程 (特定协议)

```
用户发起争议
    │
    ▼
┌─────────────────┐
│  验证争议条件    │
│  - 断言状态      │
│  - 争议窗口期    │
│  - 质押金额      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  调用智能合约    │
│  - dispute()     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  区块链事件监听  │────▶│  更新争议状态    │
│  DisputeMade    │     │  - 标记争议      │
└─────────────────┘     │  - 通知相关方    │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  投票阶段开始    │
                        │  - UMA DVM      │
                        │  - 投票奖励计算  │
                        └─────────────────┘
```

### 4. 数据同步流程

```
┌─────────────────┐
│   定时触发器     │
│  (Cron Job)     │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                    多协议并行同步                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │
│  │  UMA Events │  │ Chainlink   │  │   Pyth      │         │
│  │  - Assertion│  │   Prices    │  │   Prices    │         │
│  │  - Dispute  │  │             │  │             │         │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘         │
│         │                │                │                │
│         └────────────────┼────────────────┘                │
│                          │                                 │
│                          ▼                                 │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  批量处理事件    │     │  数据库更新                  │  │
│  │  - 解析参数      │     │  - 插入新记录                │  │
│  │  - 验证数据      │     │  - 更新状态                  │  │
│  └─────────────────┘     │  - 缓存刷新                   │  │
│                          └────────┬────────┘              │
│                                   │                        │
│                                   ▼                        │
│                          ┌─────────────────┐              │
│                          │  发送实时通知    │              │
│                          │  - WebSocket    │              │
│                          │  - Webhook      │              │
│                          └─────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 4. 告警处理流程

```
事件触发
    │
    ▼
┌─────────────────┐
│  评估告警规则    │
│  - 条件匹配      │
│  - 严重级别      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  去重检查        │
│  - 相似告警      │
│  - 冷却时间      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  创建告警记录    │
│  - 存储到数据库  │
│  - 更新缓存      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  发送邮件通知    │────▶│  发送 Telegram  │────▶│  发送 Webhook   │
│                 │     │                 │     │                 │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## 组件关系图

```
┌─────────────────────────────────────────────────────────────────┐
│                        前端组件架构                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     Page Components                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │   │
│  │  │  Home   │ │ Oracle  │ │ Disputes│ │     Admin       │ │   │
│  │  │  Page   │ │  Page   │ │  Page   │ │     Page        │ │   │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────────┬────────┘ │   │
│  │       └─────────────┴───────────┴───────────────┘          │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                 Feature Components                   │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │   │
│  │  │  │Assertion │ │  Dispute │ │  Alert   │ │  Chart  │ │  │   │
│  │  │  │  List    │ │  Modal   │ │  Manager │ │         │ │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                   UI Components                      │  │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────────────┐  │  │   │
│  │  │  │ Button │ │  Card  │ │  Input │ │    Modal     │  │  │   │
│  │  │  └────────┘ └────────┘ └────────┘ └──────────────┘  │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                    Custom Hooks                      │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │   │
│  │  │  │useOracle │ │ useAlert │ │useWallet │ │ useUser │ │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 数据流

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │────▶│   Action    │────▶│    Hook     │────▶│   SWR Cache │
│  Interaction│     │   Trigger   │     │   Call      │     │   (Client)  │
└─────────────┘     └─────────────┘     └──────┬──────┘     └──────┬──────┘
                                               │                    │
                                               ▼                    │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐            │
│   UI Update │◀────│  Re-render  │◀────│  Data Fetch │◀───────────┘
│             │     │             │     │   Response  │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  API Route  │
                                        │             │
                                        │ - Rate Limit│
                                        │ - Auth Check│
                                        │ - Validation│
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   Service   │
                                        │   Layer     │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │    Cache    │
                                        │   (Redis)   │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  Database   │
                                        │(PostgreSQL) │
                                        └─────────────┘
```

## 部署架构

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           Vercel + Supabase 架构                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Vercel Edge Network                         │   │
│  │                     - 静态资源缓存                                  │   │
│  │                     - 边缘计算 (Edge Functions)                     │   │
│  │                     - 全球 CDN                                      │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Next.js Application                            │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │   │
│  │  │ API Routes  │  │ SSR Pages   │  │ Static Pages│                 │   │
│  │  │ (Serverless)│  │ (Edge/Node) │  │ (CDN)       │                 │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Data Layer                                     │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Supabase                                 │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │   │
│  │  │  │ PostgreSQL  │  │  Auth       │  │  Realtime   │         │   │   │
│  │  │  │  (Managed)  │  │  (Built-in) │  │  (Optional) │         │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐                                  │   │
│  │  │ Memory Cache│  │   RPC Pool  │                                  │   │
│  │  │ (Default)   │  │             │                                  │   │
│  │  └─────────────┘  └─────────────┘                                  │   │
│  │                                                                     │   │
│  │  Optional: Redis (via REDIS_URL)                                   │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 安全架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        安全层架构                                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    应用层安全                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │   CSP    │ │   CORS   │ │   CSRF   │ │  XSS     │   │   │
│  │  │  Headers │ │  Config  │ │  Tokens  │ │ Protection│   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    认证授权层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │  Wallet  │ │  Admin   │ │  Session │ │   JWT    │   │   │
│  │  │  Auth    │ │  Token   │ │   Mgmt   │ │  Verify  │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    API 安全层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │  Rate    │ │  Input   │ │  Output  │ │  Audit   │   │   │
│  │  │  Limit   │ │ Validate │ │ Sanitize │ │   Log    │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                              │                                  │
│                              ▼                                  │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    数据安全层                            │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │   SQL    │ │   Data   │ │  Backup  │ │  Encrypt │   │   │
│  │  │Injection │ │  Encrypt │ │   Mgmt   │ │  at Rest │   │   │
│  │  │  Protect │ │          │ │          │ │          │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 监控架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        监控体系                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   应用监控       │  │   性能监控       │  │   业务监控       │  │
│  │                 │  │                 │  │                 │  │
│  │  - Sentry       │  │  - Web Vitals   │  │  - 断言统计      │  │
│  │  - Error Track  │  │  - LCP/FCP/CLS  │  │  - 争议统计      │  │
│  │  - Log Aggregation│ │- API Latency   │  │  - 用户活跃度    │  │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘  │
│           │                    │                    │           │
│           └────────────────────┼────────────────────┘           │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                    告警中心                              │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │   │
│  │  │  Email   │ │ Telegram │ │  Webhook │ │  PagerDuty│   │   │
│  │  │  Alert   │ │  Alert   │ │  Alert   │ │   Alert   │   │   │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## 技术栈

| 层级     | 技术                | 用途                     |
| -------- | ------------------- | ------------------------ |
| 前端框架 | Next.js 16          | React 框架，支持 SSR/SSG |
| 语言     | TypeScript 5.7      | 类型安全                 |
| 样式     | Tailwind CSS 3.4    | 原子化 CSS               |
| UI 组件  | Radix UI + 自定义   | 可访问性组件             |
| 状态管理 | SWR                 | 数据获取和缓存           |
| 区块链   | Viem 2.43           | 与智能合约交互           |
| 后端     | Next.js API Routes  | API 端点                 |
| 数据库   | PostgreSQL 16       | 主数据库                 |
| ORM      | Prisma 6            | 数据库操作               |
| 缓存     | Memory / Redis      | 内存缓存（默认）或 Redis |
| 测试     | Vitest + Playwright | 单元测试和 E2E           |
| 监控     | Sentry + Web Vitals | 错误追踪和性能监控       |
| 部署     | Vercel              | Serverless 部署          |

## 扩展性设计

1. **Serverless 架构**: 无状态设计，天然支持自动扩展
2. **数据库**: Supabase 托管 PostgreSQL，自动扩展
3. **缓存**: 多级缓存策略（客户端 + 内存/Redis）
4. **CDN**: Vercel Edge Network 全球缓存
5. **边缘计算**: 支持 Vercel Edge Functions
