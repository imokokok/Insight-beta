# Insight Architecture Documentation

## System Architecture Overview

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              User Layer                                      │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │   Web App   │  │  Mobile App │  │   API Client │  │   Third-party       │  │
│  │  (Next.js)  │  │  (PWA)      │  │              │  │   Integrations      │  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
└─────────┼────────────────┼────────────────┼────────────────────┼─────────────┘
          │                │                │                    │
          └────────────────┴────────────────┴────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           API Gateway Layer                                   │
│  ┌────────────────────────────────────────────────────────────────────────┐  │
│  │                         Next.js API Routes                             │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────────┐  │  │
│  │  │  Rate    │ │   Auth   │ │ Validate │ │  Cache   │ │    Audit     │  │  │
│  │  │  Limit   │ │          │ │          │ │          │ │     Log      │  │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ └──────────────┘  │  │
│  └────────────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Service Layer                                        │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐              │
│  │  Unified Oracle  │  │  Alert Service  │  │  Audit Service  │              │
│  │    Service      │  │                 │  │                 │              │
│  │                 │  │ - Alert Rules   │  │ - Audit Logs    │              │
│  │ - Multi-Protocol│  │ - Notifications │  │ - Statistics    │              │
│  │   Aggregation   │  │ - Webhooks      │  │ - Export        │              │
│  │ - Price Sync    │  │                 │  │                 │              │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘              │
│           │                    │                    │                        │
│  ┌────────┴────────┐  ┌────────┴────────┐  ┌────────┴────────┐              │
│  │ Protocol Services│  │  Config Service │  │  User Service   │              │
│  │                  │  │                 │  │                 │              │
│  │ - UMA (Assertions│  │ - Config Mgmt   │  │ - Watchlist     │              │
│  │   & Disputes)   │  │ - Versioning    │  │ - Preferences   │              │
│  │ - Chainlink/Pyth│  │ - Templates     │  │ - Stats         │              │
│  │   Price Feeds   │  │                 │  │                 │              │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘              │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                          Data Layer                                          │
│  ┌─────────────────┐  ┌─────────────────┐                                  │
│  │   PostgreSQL    │  │   Blockchain    │                                  │
│  │                 │  │                 │                                  │
│  │ - Assertions    │  │ - Smart Contracts│                                 │
│  │ - Disputes      │  │ - Events        │                                  │
│  │ - Alerts        │  │ - Transactions  │                                  │
│  │ - Users         │  │                 │                                  │
│  └─────────────────┘  └─────────────────┘                                  │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Core Flows

### 1. Price Data Aggregation Flow

```
┌─────────────────────────────────────────────────────────────┐
│                  Multi-Protocol Price Sync                   │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐       │
│  │  Chainlink  │  │    Pyth     │  │  RedStone   │       │
│  │    Sync     │  │    Sync     │  │    Sync     │       │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘       │
│         │                │                │                │
│         └────────────────┼────────────────┘                │
│                          │                                 │
│                          ▼                                 │
│  ┌─────────────────────────────────────────────────────┐   │
│  │              Unified Price Aggregator                │   │
│  │                                                      │   │
│  │  - Outlier Detection                               │   │
│  │  - Weighted Average Calculation                    │   │
│  │  - Confidence Scoring                              │   │
│  │  - Price Deviation Analysis                       │   │
│  └────────────────────────┬────────────────────────────┘   │
│                           │                                │
│                           ▼                                │
│  ┌─────────────────────────────────────────────────────┐   │
│  │                   Data Distribution                 │   │
│  │                                                      │   │
│  │  - WebSocket Real-time Push                        │   │
│  │  - REST API Query                                  │   │
│  │  - Alert Triggering                                │   │
│  └─────────────────────────────────────────────────────┘   │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2. UMA Assertion Creation Flow (Protocol-Specific)

```
User Creates Assertion
    │
    ▼
┌─────────────────┐
│  Frontend Input │
│  Validation      │
│  - Address      │
│  - Amount       │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Call Smart     │
│  Contract        │
│  - assertTruth() │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  Blockchain     │────▶│  Indexer        │
│  Event Listener │     │  Processing     │
│  AssertionMade  │     │  - Parse Event │
└─────────────────┘     │  - Store to DB  │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  Trigger Alert  │
                        │  Check          │
                        │  - Rule Match   │
                        │  - Send         │
                        │    Notification │
                        └─────────────────┘
```

### 3. UMA Dispute Handling Flow (Protocol-Specific)

```
User Initiates Dispute
    │
    ▼
┌─────────────────┐
│  Validate       │
│  Dispute        │
│  Conditions     │
│  - Assertion    │
│    Status       │
│  - Dispute      │
│    Window       │
│  - Bond Amount  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Call Smart     │
│  Contract        │
│  - dispute()    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐
│  Blockchain     │────▶│  Update Dispute │
│  Event Listener │     │  Status         │
│  DisputeMade    │     │  - Mark Dispute │
└─────────────────┘     │  - Notify       │
                        │    Parties       │
                        └────────┬────────┘
                                 │
                                 ▼
                        ┌─────────────────┐
                        │  Voting Phase   │
                        │  Begins         │
                        │  - UMA DVM     │
                        │  - Vote Reward │
                        │    Calculation  │
                        └─────────────────┘
```

### 4. Data Sync Flow

```
┌─────────────────┐
│   Timer         │
│  (Cron Job)     │
└────────┬────────┘
         │
         ▼
┌─────────────────────────────────────────────────────────────┐
│                  Multi-Protocol Parallel Sync                │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐        │
│  │  UMA Events │  │ Chainlink   │  │   Pyth      │        │
│  │  - Assertion│  │   Prices    │  │   Prices    │        │
│  │  - Dispute │  │             │  │             │        │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘        │
│         │                │                │                │
│         └────────────────┼────────────────┘                │
│                          │                                 │
│                          ▼                                 │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  Batch Process Events  │  Database Updates         │  │
│  │  - Parse Parameters    │  - Insert New Records     │  │
│  │  - Validate Data       │  - Update Status          │  │
│  └─────────────────┘     │  - Refresh Cache           │  │
│                          └────────┬────────┘              │
│                                   │                        │
│                                   ▼                        │
│                          ┌─────────────────┐              │
│                          │  Send Real-time │              │
│                          │  Notifications  │              │
│                          │  - WebSocket    │              │
│                          │  - Webhook      │              │
│                          └─────────────────┘              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 5. Alert Handling Flow

```
Event Triggers
    │
    ▼
┌─────────────────┐
│  Evaluate Alert │
│  Rules          │
│  - Condition    │
│    Match        │
│  - Severity     │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Deduplication  │
│  Check          │
│  - Similar      │
│    Alerts       │
│  - Cool-down    │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  Create Alert   │
│  Record         │
│  - Store to DB  │
│  - Update Cache │
└────────┬────────┘
         │
         ▼
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  Send Email    │────▶│  Send Telegram │────▶│  Send Webhook  │
│  Notification  │     │  Notification  │     │  Notification   │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

## Component Relationship Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│                     Frontend Component Architecture               │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                     Page Components                      │   │
│  │  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────────────┐ │   │
│  │  │  Home   │ │ Oracle  │ │ Disputes│ │     Admin       │ │   │
│  │  │  Page   │ │  Page   │ │  Page   │ │     Page        │ │   │
│  │  └────┬────┘ └────┬────┘ └────┬────┘ └────────┬────────┘ │   │
│  │       └─────────────┴───────────┴───────────────┘          │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                 Feature Components                   │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │   │
│  │  │  │Assertion │ │  Dispute │ │  Alert   │ │  Chart  │ │  │   │
│  │  │  │  List    │ │  Modal   │ │  Manager │ │         │ │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                   UI Components                      │  │   │
│  │  │  ┌────────┐ ┌────────┐ ┌────────┐ ┌──────────────┐  │  │   │
│  │  │  │ Button │ │  Card  │ │  Input │ │    Modal     │  │  │   │
│  │  │  └────────┘ └────────┘ └────────┘ └──────────────┘  │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  │                         │                                  │   │
│  │                         ▼                                  │   │
│  │  ┌─────────────────────────────────────────────────────┐  │   │
│  │  │                    Custom Hooks                      │  │   │
│  │  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌─────────┐ │  │   │
│  │  │  │useOracle │ │ useAlert │ │useWallet │ │ useUser │ │  │   │
│  │  │  └──────────┘ └──────────┘ └──────────┘ └─────────┘ │  │   │
│  │  └─────────────────────────────────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Data Flow

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    User     │────▶│   Action    │────▶│    Hook     │────▶│   SWR Cache │
│  Interaction│     │   Trigger   │     │   Call      │     │   (Client)  │
└─────────────┘     └─────────────┘     └──────┬──────┘     └──────┬──────┘
                                               │                    │
                                               ▼                    │
┌─────────────┐     ┌─────────────┐     ┌─────────────┐            │
│   UI Update │◀────│  Re-render  │◀────│  Data Fetch │◀───────────┘
│             │     │             │     │   Response  │
└─────────────┘     └─────────────┘     └─────────────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  API Route  │
                                        │             │
                                        │ - Rate Limit│
                                        │ - Auth Check│
                                        │ - Validation│
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │   Service   │
                                        │   Layer     │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │    Cache    │
                                        │   (Memory)  │
                                        └──────┬──────┘
                                               │
                                               ▼
                                        ┌─────────────┐
                                        │  Database   │
                                        │(PostgreSQL) │
                                        └─────────────┘
```

## Deployment Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Vercel + Supabase Architecture                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                         Vercel Edge Network                          │   │
│  │                     - Static Resource Cache                          │   │
│  │                     - Edge Computing                                 │   │
│  │                     - Global CDN                                     │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Next.js Application                              │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                 │   │
│  │  │ API Routes  │  │ SSR Pages   │  │ Static Pages│                 │   │
│  │  │ (Serverless)│  │ (Edge/Node) │  │ (CDN)       │                 │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘                 │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                    │                                        │
│                                    ▼                                        │
│  ┌─────────────────────────────────────────────────────────────────────┐   │
│  │                      Data Layer                                      │   │
│  │  ┌─────────────────────────────────────────────────────────────┐   │   │
│  │  │                    Supabase                                 │   │   │
│  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         │   │   │
│  │  │  │ PostgreSQL  │  │    Auth     │  │  Realtime   │         │   │   │
│  │  │  │  (Managed)  │  │  (Built-in) │  │  (Optional) │         │   │   │
│  │  │  └─────────────┘  └─────────────┘  └─────────────┘         │   │   │
│  │  └─────────────────────────────────────────────────────────────┘   │   │
│  │                                                                     │   │
│  │  ┌─────────────┐  ┌─────────────┐                                  │   │
│  │  │ Memory Cache│  │   RPC Pool  │                                  │   │
│  │  │ (Rate Limit)│  │             │                                  │   │
│  │  └─────────────┘  └─────────────┘                                  │   │
│  └─────────────────────────────────────────────────────────────────────┘   │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Security Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                     Security Layer Architecture                  │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                   Application Layer Security              │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐    │  │
│  │  │   CSP    │ │   CORS   │ │   CSRF   │ │  XSS     │    │  │
│  │  │  Headers │ │  Config  │ │  Tokens  │ │Protection│    │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘    │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                   Authentication & Authorization          │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │
│  │  │  Wallet  │ │  Admin   │ │  Session │ │   JWT    │   │  │
│  │  │  Auth    │ │  Token   │ │   Mgmt   │ │  Verify  │   │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                      API Security Layer                  │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │
│  │  │  Rate    │ │  Input   │ │  Output  │ │  Audit   │   │  │
│  │  │  Limit   │ │ Validate │ │ Sanitize │ │   Log    │   │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                              │                                 │
│                              ▼                                 │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │                     Data Security Layer                  │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐   │  │
│  │  │   SQL    │ │   Data   │ │  Backup  │ │  Encrypt │   │  │
│  │  │Injection │ │  Encrypt │ │   Mgmt   │ │  at Rest │   │  │
│  │  │  Protect │ │          │ │          │ │          │   │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Monitoring Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│                      Monitoring System                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐ │
│  │   Application   │  │   Performance    │  │   Business      │ │
│  │   Monitoring   │  │   Monitoring     │  │   Monitoring    │ │
│  │                 │  │                 │  │                 │ │
│  │  - Sentry      │  │  - Web Vitals   │  │  - Assertion    │ │
│  │  - Error Track │  │  - LCP/FCP/CLS  │  │    Stats        │ │
│  │  - Log Aggreg. │  │  - API Latency  │  │  - Dispute      │ │
│  │                │  │                 │  │    Stats         │ │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘ │
│           │                    │                    │          │
│           └────────────────────┼────────────────────┘          │
│                                │                                │
│                                ▼                                │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      Alert Center                        │   │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐ │  │
│  │  │  Email   │ │ Telegram │ │  Webhook │ │  PagerDuty│ │  │
│  │  │  Alert   │ │  Alert   │ │  Alert   │ │   Alert   │ │  │
│  │  └──────────┘ └──────────┘ └──────────┘ └──────────┘ │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

## Technology Stack

| Layer              | Technology          | Purpose                              |
| ------------------ | ------------------- | ------------------------------------ |
| Frontend Framework | Next.js 16          | React framework with SSR/SSG support |
| Language           | TypeScript 5.7      | Type safety                          |
| Styling            | Tailwind CSS 3.4    | Atomic CSS                           |
| UI Components      | Radix UI + Custom   | Accessible components                |
| State Management   | SWR                 | Data fetching and caching            |
| Blockchain         | Viem 2.43           | Smart contract interaction           |
| Backend            | Next.js API Routes  | API endpoints                        |
| Database           | PostgreSQL 16       | Primary database                     |
| Query Builder      | pg                  | Direct SQL queries                   |
| Cache              | Memory / PostgreSQL | Memory cache + database cache        |
| Testing            | Vitest + Playwright | Unit and E2E tests                   |
| Monitoring         | Sentry + Web Vitals | Error tracking and performance       |
| Deployment         | Vercel              | Serverless deployment                |

## Scalability Design

1. **Serverless Architecture**: Stateless design, auto-scaling enabled
2. **Database**: Supabase managed PostgreSQL, auto-scaling
3. **Caching**: Multi-level caching (client SWR + Memory + PostgreSQL)
4. **CDN**: Vercel Edge Network global caching
5. **Edge Computing**: Vercel Edge Functions support
