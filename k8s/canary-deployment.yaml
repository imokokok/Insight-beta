apiVersion: flagger.app/v1beta1
kind: Canary
metadata:
  name: oracle-monitor
  namespace: default
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: oracle-monitor
  service:
    port: 3000
    gateways:
    - istio-gateway
    hosts:
    - oracle-monitor.io
  analysis:
    interval: 1m
    threshold: 5
    maxWeight: 50
    stepWeight: 10
    metrics:
    - name: request-success-rate
      thresholdRange:
        min: 99
      interval: 1m
    - name: request-duration
      thresholdRange:
        max: 500
      interval: 1m
    - name: custom-error-rate
      query: |
        sum(rate(http_requests_total{status=~"5.."}[1m])) 
        / 
        sum(rate(http_requests_total[1m])) * 100
      thresholdRange:
        max: 1
      interval: 1m
    webhooks:
    - name: load-test
      type: pre-rollout
      url: http://flagger-loadtester.test/
      timeout: 5s
      metadata:
        cmd: "hey -z 1m -q 10 -c 2 http://oracle-monitor-canary:3000/"
    - name: conformance-test
      type: pre-rollout
      url: http://flagger-loadtester.test/
      timeout: 30s
      metadata:
        type: bash
        cmd: "curl -sf http://oracle-monitor-canary:3000/api/health"
    - name: promotion-gate
      type: confirm-promotion
      url: http://flagger-loadtester.test/gate/check
      timeout: 10s
    - name: rollback
      type: rollback
      url: http://flagger-loadtester.test/rollback/check
      timeout: 5s
  progressDeadlineSeconds: 600
  autoscalerRef:
    apiVersion: autoscaling/v2
    kind: HorizontalPodAutoscaler
    name: oracle-monitor
  skipAnalysis: false
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: oracle-monitor
  namespace: default
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: oracle-monitor
  minReplicas: 3
  maxReplicas: 20
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
      - type: Percent
        value: 10
        periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
      - type: Percent
        value: 100
        periodSeconds: 15
      - type: Pods
        value: 4
        periodSeconds: 15
      selectPolicy: Max
