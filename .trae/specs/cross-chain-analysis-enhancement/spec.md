# 跨链分析页面增强 Spec

## Why
跨链分析页面作为预言机数据分析平台的核心模块，当前存在以下问题：
1. **图表组件未实现**：`CrossChainPriceChart`、`CrossChainDeviationChart`、`CrossChainComparisonBar` 均为占位符状态
2. **功能完整度不足**：缺少跨链特有的分析功能，如套利机会详情、跨链桥监控等
3. **UI 交互体验欠佳**：缺少数据可视化、链间关系展示、实时状态更新
4. **与其他页面功能重叠风险**：需避免与 Oracle Comparison（热力图、延迟分析）、Alerts Center（告警系统）、Deviation Analytics（时间范围选择器）功能重复

## What Changes
- 实现占位符图表组件（价格趋势图、偏差分析图、链对比柱状图）
- 增加跨链套利机会分析模块（独立于告警系统）
- 增加跨链桥状态监控功能
- 增加跨链价格相关性矩阵
- 增加跨链流动性分析
- 增加跨链风险评分系统
- 优化 UI 布局和交互体验

## Impact
- Affected specs: cross-chain-analysis, data-visualization, user-experience
- Affected code:
  - `src/features/cross-chain/components/` - 图表实现
  - `src/features/cross-chain/hooks/` - 数据获取逻辑
  - `src/types/crossChainAnalysisTypes.ts` - 类型扩展
  - `src/app/api/cross-chain/` - API 扩展

---

## 当前页面功能评估

### 已实现功能 ✅

| 功能模块 | 页面 | 状态 | 说明 |
|---------|------|------|------|
| 概览 Dashboard | Overview | ✅ 完整 | 活跃告警、套利机会、链健康状态、价格状态 |
| 阈值设置 | Overview | ✅ 完整 | 警告/严重偏差阈值配置 |
| 数据源配置 | Comparison | ✅ 完整 | Chainlink/Pyth/Band Protocol 开关 |
| 链选择器 | Comparison/History | ✅ 完整 | 多链选择和切换 |
| 交易对选择 | Comparison/History | ✅ 完整 | BTC/ETH/SOL 等 8 种资产 |
| 时间范围选择 | Comparison/History | ✅ 完整 | 24h/7d/30d/90d |
| 价格对比卡片 | Comparison | ✅ 完整 | 显示各链价格、偏差、状态 |
| 统计摘要 | Comparison | ✅ 完整 | 均价、中位数、价格区间、可靠来源 |
| 历史数据卡片 | History | ✅ 完整 | 平均偏差、最大偏差、收敛/发散次数 |

### 未实现功能 ❌

| 功能模块 | 优先级 | 说明 |
|---------|--------|------|
| 价格趋势图表 | P0 | `CrossChainPriceChart` 为占位符 |
| 偏差分析图表 | P0 | `CrossChainDeviationChart` 为占位符 |
| 链对比柱状图 | P0 | `CrossChainComparisonBar` 需检查实现 |
| 套利机会详情 | P1 | 概览显示数量，无详情页面 |
| 跨链桥监控 | P1 | 缺少桥状态和延迟监控 |
| 价格相关性分析 | P2 | 缺少链间价格相关性矩阵 |
| 流动性分析 | P2 | 缺少跨链流动性数据 |
| 风险评分 | P2 | 缺少跨链风险评分系统 |

---

## 与其他页面功能对比

### 避免重复的功能（已在其他页面实现）

| 功能 | 所在页面 | 跨链页面处理方式 |
|------|---------|-----------------|
| 热力图 | Oracle Comparison | ❌ 不重复实现，可添加跳转链接 |
| 延迟分析 | Oracle Comparison | ❌ 不重复实现，专注于跨链延迟 |
| 成本效益分析 | Oracle Comparison | ❌ 不重复实现 |
| 告警系统 | Alerts Center | ❌ 不重复实现，概览仅显示摘要 |
| 协议筛选 | Deviation Analytics | ✅ 可复用，但针对跨链场景 |
| 时间范围选择 | Deviation Analytics | ✅ 已实现，保持一致 |

### 跨链页面独有功能

| 功能 | 说明 | 优先级 |
|------|------|--------|
| 跨链套利分析 | 分析不同链间的价格差异套利机会 | P1 |
| 跨链桥监控 | 监控跨链桥状态、延迟、费用 | P1 |
| 价格相关性矩阵 | 展示不同链上同资产价格的相关性 | P2 |
| 跨链流动性 | 分析各链流动性深度 | P2 |
| 风险评分 | 综合评估跨链操作风险 | P2 |

---

## ADDED Requirements

### Requirement: 价格趋势图表实现
系统 SHALL 实现跨链价格趋势图表，展示所选资产在各链上的历史价格走势。

#### Scenario: 查看多链价格趋势
- **WHEN** 用户在 Comparison 或 History 页面
- **THEN** 显示所选资产在各链上的价格折线图，支持图例切换

#### Scenario: 价格趋势交互
- **WHEN** 用户悬停在图表数据点上
- **THEN** 显示该时间点的详细价格信息（链名、价格、时间）

### Requirement: 偏差分析图表实现
系统 SHALL 实现偏差分析图表，展示价格偏差随时间的变化趋势。

#### Scenario: 查看偏差趋势
- **WHEN** 用户在 History 页面
- **THEN** 显示偏差随时间变化的折线图，标注阈值线

#### Scenario: 偏差阈值可视化
- **WHEN** 用户设置了偏差阈值
- **THEN** 图表中显示警告和严重阈值线

### Requirement: 链对比柱状图实现
系统 SHALL 实现链对比柱状图，直观展示各链价格与均价的偏差。

#### Scenario: 查看链价格对比
- **WHEN** 用户在 Comparison 页面
- **THEN** 显示各链价格的柱状图，标注均价线

### Requirement: 跨链套利机会分析
系统 SHALL 提供跨链套利机会分析功能，展示潜在的套利机会详情。

#### Scenario: 查看套利机会列表
- **WHEN** 用户点击概览页的"套利机会"卡片
- **THEN** 展开显示套利机会详情列表，包含：资产、买入链、卖出链、价差、预估收益

#### Scenario: 套利机会详情
- **WHEN** 用户点击某个套利机会
- **THEN** 显示详细的套利路径、费用估算、风险评估

### Requirement: 跨链桥状态监控
系统 SHALL 提供跨链桥状态监控功能，展示主要跨链桥的运行状态。

#### Scenario: 查看桥状态概览
- **WHEN** 用户在 Overview 页面
- **THEN** 显示主要跨链桥的状态卡片（状态、延迟、费用）

#### Scenario: 查看桥详情
- **WHEN** 用户点击某个桥状态卡片
- **THEN** 显示该桥的详细监控数据（历史延迟、费用变化、交易量）

### Requirement: 价格相关性矩阵
系统 SHALL 提供价格相关性矩阵，展示不同链上同资产价格的相关性。

#### Scenario: 查看相关性矩阵
- **WHEN** 用户在 Comparison 页面
- **THEN** 显示链间价格相关性热力矩阵

### Requirement: 跨链流动性分析
系统 SHALL 提供跨链流动性分析功能，展示各链的流动性深度。

#### Scenario: 查看流动性分布
- **WHEN** 用户在 Overview 页面
- **THEN** 显示各链流动性分布图

### Requirement: 跨链风险评分
系统 SHALL 提供跨链风险评分功能，综合评估跨链操作风险。

#### Scenario: 查看风险评分
- **WHEN** 用户查看某资产
- **THEN** 显示该资产的跨链风险评分（基于价格偏差、流动性、桥状态等）

---

## MODIFIED Requirements

### Requirement: Overview 页面布局优化
原有的 Overview 页面 SHALL 增加套利机会详情和跨链桥状态模块。

**变更详情**：
- 套利机会卡片改为可展开，显示详情列表
- 新增跨链桥状态监控区域
- 新增流动性分布概览

### Requirement: Comparison 页面图表完善
原有的 Comparison 页面 SHALL 实现占位符图表组件。

**变更详情**：
- 实现 `CrossChainPriceChart` 组件
- 实现 `CrossChainComparisonBar` 组件
- 新增价格相关性矩阵

### Requirement: History 页面图表完善
原有的 History 页面 SHALL 实现占位符图表组件。

**变更详情**：
- 实现 `CrossChainPriceChart` 组件
- 实现 `CrossChainDeviationChart` 组件
- 增加偏差趋势分析

---

## UI 改进建议

### 1. Overview 页面
```
┌─────────────────────────────────────────────────────────────┐
│ 跨链概览                                    [设置] [刷新]   │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐            │
│ │活跃告警  │ │套利机会  │ │链健康度  │ │价格状态  │            │
│ │   3     │ │   5     │ │  6/7    │ │ Normal  │            │
│ └─────────┘ └─────────┘ └─────────┘ └─────────┘            │
├─────────────────────────────────────────────────────────────┤
│ 套利机会详情 (可展开)                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ 资产  │ 买入链  │ 卖出链  │ 价差   │ 预估收益 │ 风险    │ │
│ │ BTC   │ BSC     │ ETH     │ 0.15%  │ $150    │ 低      │ │
│ │ ETH   │ Polygon │ Arbitrum│ 0.12%  │ $120    │ 低      │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ 跨链桥状态                                                   │
│ ┌──────────┐ ┌──────────┐ ┌──────────┐ ┌──────────┐        │
│ │ Multichain│ │ Stargate │ │ LayerZero│ │ Wormhole │        │
│ │ 🟢 正常   │ │ 🟡 延迟  │ │ 🟢 正常  │ │ 🟢 正常  │        │
│ │ 延迟: 2m  │ │ 延迟: 8m │ │ 延迟: 1m │ │ 延迟: 3m │        │
│ └──────────┘ └──────────┘ └──────────┘ └──────────┘        │
├─────────────────────────────────────────────────────────────┤
│ 链健康状态                                                   │
│ [Ethereum 🟢] [BSC 🟢] [Polygon 🟡] [Avalanche 🟢] ...      │
├─────────────────────────────────────────────────────────────┤
│ 价格状态概览                                                 │
│ [BTC: Normal] [ETH: Warning] [SOL: Normal] ...              │
└─────────────────────────────────────────────────────────────┘
```

### 2. Comparison 页面
```
┌─────────────────────────────────────────────────────────────┐
│ 跨链价格对比                               [数据源] [刷新]   │
├─────────────────────────────────────────────────────────────┤
│ [BTC ▼] [链选择: ETH BSC Polygon AVAX ARB OP Base] [7d ▼]  │
├─────────────────────────────────────────────────────────────┤
│ 统计卡片: 监控链数 | 价格区间 | 状态                         │
├─────────────────────────────────────────────────────────────┤
│ 价格对比卡片 (已实现)                                        │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────┐ ┌─────────────────────┐            │
│ │   价格趋势图表       │ │   链对比柱状图       │            │
│ │   (待实现)          │ │   (待实现)          │            │
│ └─────────────────────┘ └─────────────────────┘            │
├─────────────────────────────────────────────────────────────┤
│ 价格相关性矩阵 (新增)                                        │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │        │ ETH  │ BSC  │ Polygon│ AVAX │ ARB  │          │ │
│ │ ETH    │ 1.00 │ 0.98 │  0.97  │ 0.96 │ 0.99 │          │ │
│ │ BSC    │ 0.98 │ 1.00 │  0.99  │ 0.95 │ 0.97 │          │ │
│ │ ...    │      │      │        │      │      │          │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 3. History 页面
```
┌─────────────────────────────────────────────────────────────┐
│ 历史分析                                      [刷新]        │
├─────────────────────────────────────────────────────────────┤
│ [BTC ▼] [链选择] [时间范围]                                  │
├─────────────────────────────────────────────────────────────┤
│ 历史数据卡片 (已实现)                                        │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │              价格趋势图表 (待实现)                        │ │
│ │   - 多链价格折线图                                       │ │
│ │   - 图例切换                                             │ │
│ │   - 缩放和拖动                                           │ │
│ └─────────────────────────────────────────────────────────┘ │
├─────────────────────────────────────────────────────────────┤
│ ┌─────────────────────────────────────────────────────────┐ │
│ │              偏差分析图表 (待实现)                        │ │
│ │   - 偏差随时间变化                                       │ │
│ │   - 阈值线标注                                           │ │
│ │   - 异常点高亮                                           │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

---

## 技术实现建议

### 组件结构
```
cross-chain/
├── components/
│   ├── charts/                    # 新增：图表组件
│   │   ├── CrossChainPriceChart.tsx      # 价格趋势图
│   │   ├── CrossChainDeviationChart.tsx  # 偏差分析图
│   │   ├── CrossChainComparisonBar.tsx   # 链对比柱状图
│   │   ├── CorrelationMatrix.tsx         # 相关性矩阵
│   │   └── index.ts
│   ├── arbitrage/                 # 新增：套利分析
│   │   ├── ArbitrageOpportunityList.tsx
│   │   ├── ArbitrageDetail.tsx
│   │   └── index.ts
│   ├── bridge/                    # 新增：跨链桥监控
│   │   ├── BridgeStatusCard.tsx
│   │   ├── BridgeDetail.tsx
│   │   └── index.ts
│   ├── liquidity/                 # 新增：流动性分析
│   │   ├── LiquidityDistribution.tsx
│   │   └── index.ts
│   └── risk/                      # 新增：风险评分
│       ├── RiskScore.tsx
│       └── index.ts
├── hooks/
│   ├── useCrossChain.ts           # 已有
│   ├── useArbitrage.ts            # 新增
│   ├── useBridgeStatus.ts         # 新增
│   ├── useCorrelation.ts          # 新增
│   └── useLiquidity.ts            # 新增
```

### 图表库选择
- 使用项目已有的图表库（需检查项目依赖）
- 推荐使用 Recharts 或 ECharts（根据项目现有实现）

### API 扩展
```
/api/cross-chain/
├── dashboard/route.ts      # 已有
├── comparison/route.ts     # 已有
├── history/route.ts        # 已有
├── arbitrage/route.ts      # 新增：套利机会
├── bridges/route.ts        # 新增：跨链桥状态
├── correlation/route.ts    # 新增：价格相关性
└── liquidity/route.ts      # 新增：流动性数据
```
