# 预言机分析页面优化 Spec

## Why
预言机分析页面（偏差分析）作为用户进入平台的第一页，当前功能基本完整但存在以下问题：缺少关键的数据筛选和对比功能、UI 交互体验不够流畅、缺少引导性内容帮助用户理解数据、以及部分数据可视化能力不足。需要进行系统性优化以提升用户的数据分析效率和整体体验。

## What Changes
- 增加时间范围选择器，支持自定义分析窗口
- 增加协议筛选功能，支持多协议对比分析
- 优化页面布局，增加引导性内容
- 增强数据可视化，添加热力图和散点图
- 增加数据导出格式选择（CSV、Excel）
- 优化移动端响应式布局
- 增加新手引导和帮助提示
- 增加数据钻取和详情查看功能

## Impact
- Affected specs: oracle-analytics-ui, data-visualization, user-experience
- Affected code: 
  - `src/features/oracle/analytics/deviation/components/` - 组件优化
  - `src/features/oracle/analytics/deviation/hooks/` - 增加筛选逻辑
  - `src/types/analytics/deviation.ts` - 类型扩展

---

## 当前页面功能评估

### 已实现功能 ✅

| 功能模块 | 状态 | 说明 |
|---------|------|------|
| 概览 Tab | ✅ 完整 | 显示偏差分布图表、分析周期卡片、最近异常列表 |
| 趋势 Tab | ✅ 完整 | 显示交易对偏差趋势、支持搜索、详情查看 |
| 异常 Tab | ✅ 完整 | 显示异常价格偏差列表、协议价格对比 |
| 自动刷新 | ✅ 完整 | 支持自定义刷新间隔、倒计时显示 |
| 数据导出 | ⚠️ 部分 | 仅支持 JSON 格式导出 |
| 错误处理 | ✅ 完整 | 错误提示、重试机制 |
| 加载状态 | ✅ 完整 | Skeleton 加载、刷新指示器 |
| 响应式布局 | ⚠️ 部分 | 基本响应式，移动端体验可优化 |

### 缺失功能 ❌

| 功能模块 | 优先级 | 说明 |
|---------|--------|------|
| 时间范围选择器 | P0 | 当前固定24小时，需支持自定义时间范围 |
| 协议筛选 | P0 | 无法按协议筛选数据，影响分析效率 |
| 数据钻取 | P1 | 点击数据点无法查看更详细的历史数据 |
| 导出格式选择 | P1 | 仅支持 JSON，需增加 CSV、Excel 格式 |
| 新手引导 | P1 | 缺少帮助提示，新用户理解成本高 |
| 实时告警 | P2 | 缺少异常阈值告警功能 |
| 数据对比 | P2 | 无法对比不同时间段的数据 |
| 快捷键支持 | P3 | 缺少键盘快捷操作 |

---

## ADDED Requirements

### Requirement: 时间范围选择器
系统 SHALL 提供时间范围选择器，允许用户自定义数据分析的时间窗口。

#### Scenario: 选择预设时间范围
- **WHEN** 用户点击时间范围选择器
- **THEN** 显示预设选项：1小时、6小时、24小时、7天、30天、自定义

#### Scenario: 自定义时间范围
- **WHEN** 用户选择"自定义"选项
- **THEN** 显示日期时间选择器，允许选择开始和结束时间

### Requirement: 协议筛选功能
系统 SHALL 提供协议筛选功能，允许用户按预言机协议筛选数据。

#### Scenario: 单协议筛选
- **WHEN** 用户选择特定协议（如 Chainlink）
- **THEN** 页面仅显示该协议相关的偏差数据

#### Scenario: 多协议筛选
- **WHEN** 用户选择多个协议
- **THEN** 页面显示所选协议的对比数据

### Requirement: 增强数据导出
系统 SHALL 支持多种数据导出格式。

#### Scenario: 导出为 CSV
- **WHEN** 用户点击导出按钮并选择 CSV 格式
- **THEN** 下载包含当前视图数据的 CSV 文件

#### Scenario: 导出为 Excel
- **WHEN** 用户点击导出按钮并选择 Excel 格式
- **THEN** 下载包含当前视图数据的 Excel 文件

### Requirement: 新手引导系统
系统 SHALL 提供新手引导和帮助提示功能。

#### Scenario: 首次访问引导
- **WHEN** 用户首次访问分析页面
- **THEN** 显示页面功能介绍引导

#### Scenario: 帮助提示
- **WHEN** 用户悬停在指标或图表上
- **THEN** 显示该指标的含义说明

### Requirement: 数据钻取功能
系统 SHALL 支持数据钻取，允许用户查看更详细的数据。

#### Scenario: 查看交易对历史详情
- **WHEN** 用户点击趋势列表中的交易对
- **THEN** 展开显示该交易对的历史偏差曲线和详细数据点

#### Scenario: 查看异常事件详情
- **WHEN** 用户点击异常列表中的事件
- **THEN** 显示该异常事件的完整上下文信息

### Requirement: 热力图可视化
系统 SHALL 提供偏差热力图，直观展示多交易对、多时间维度的偏差分布。

#### Scenario: 查看偏差热力图
- **WHEN** 用户在概览 Tab 中
- **THEN** 显示交易对与时间维度的偏差热力图

### Requirement: 移动端体验优化
系统 SHALL 优化移动端的交互体验。

#### Scenario: 移动端图表交互
- **WHEN** 用户在移动设备上查看图表
- **THEN** 支持触摸滑动、缩放等手势操作

#### Scenario: 移动端列表优化
- **WHEN** 用户在移动设备上查看列表
- **THEN** 采用卡片式布局，优化触摸目标大小

---

## MODIFIED Requirements

### Requirement: 页面布局优化
原有的页面布局 SHALL 增加引导性内容和快速操作入口。

**变更详情**：
- 在页面顶部增加关键指标概览卡片
- 增加快速操作按钮区域
- 优化 Tab 切换的视觉反馈

### Requirement: 图表交互增强
原有的静态图表 SHALL 增加交互功能。

**变更详情**：
- 支持图表缩放和平移
- 支持数据点悬停显示详情
- 支持图表数据区域选择

---

## UI/UX 改进建议

### 1. 页面入口优化
作为平台首页，建议增加：
- **欢迎区域**：简要介绍页面功能
- **快速洞察卡片**：显示今日关键发现
- **快捷操作入口**：常用操作一键直达

### 2. 数据可视化增强
- **偏差热力图**：多维度展示偏差分布
- **散点图**：展示价格与偏差的关系
- **趋势预测线**：基于历史数据预测趋势

### 3. 交互体验优化
- **实时数据动画**：数据更新时的平滑过渡
- **骨架屏优化**：更精确的加载占位
- **操作反馈**：操作后的即时视觉反馈

### 4. 信息架构优化
- **面包屑导航**：明确当前位置
- **数据来源说明**：标注数据来源和更新时间
- **指标解释**：关键指标的含义说明

---

## 技术实现建议

### 组件结构优化
```
deviation/
├── components/
│   ├── filters/           # 新增：筛选组件
│   │   ├── TimeRangeSelector.tsx
│   │   ├── ProtocolFilter.tsx
│   │   └── index.ts
│   ├── charts/            # 新增：图表组件
│   │   ├── DeviationHeatmap.tsx
│   │   ├── DeviationScatterPlot.tsx
│   │   └── index.ts
│   ├── export/            # 新增：导出组件
│   │   ├── ExportButton.tsx
│   │   └── index.ts
│   ├── onboarding/        # 新增：引导组件
│   │   ├── WelcomeGuide.tsx
│   │   ├── HelpTooltip.tsx
│   │   └── index.ts
│   └── ...
├── hooks/
│   ├── useDeviationAnalytics.ts  # 扩展筛选逻辑
│   ├── useTimeRange.ts           # 新增
│   ├── useProtocolFilter.ts      # 新增
│   └── ...
```

### 性能优化
- 使用虚拟滚动处理大数据量列表
- 图表数据分片加载
- 缓存筛选结果
