version: '3.8'

services:
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

  # Chainlink Service
  chainlink-service:
    build:
      context: ./chainlink-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=chainlink-eth-mainnet
      - CHAIN=ethereum
      - RPC_URL=${ETHEREUM_RPC_URL:-https://eth.llamarpc.com}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=ETH/USD,BTC/USD,LINK/USD,MATIC/USD,AVAX/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M

  # Pyth Service
  pyth-service:
    build:
      context: ./pyth-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=pyth-solana-mainnet
      - CHAIN=solana
      - RPC_URL=${SOLANA_RPC_URL}
      - SYNC_INTERVAL_MS=30000
      - SYMBOLS=BTC/USD,ETH/USD,SOL/USD,AVAX/USD,ARB/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      replicas: 1
      resources:
        limits:
          cpus: '0.5'
          memory: 512M

  # Band Service
  band-service:
    build:
      context: ./band-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=band-cosmos-mainnet
      - CHAIN=band
      - RPC_URL=${BAND_RPC_URL}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=BTC/USD,ETH/USD,BAND/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # API3 Service
  api3-service:
    build:
      context: ./api3-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=api3-ethereum-mainnet
      - CHAIN=ethereum
      - RPC_URL=${ETHEREUM_RPC_URL}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=ETH/USD,BTC/USD,API3/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # RedStone Service
  redstone-service:
    build:
      context: ./redstone-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=redstone-arbitrum-mainnet
      - CHAIN=arbitrum
      - RPC_URL=${ARBITRUM_RPC_URL}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=ETH/USD,BTC/USD,ARB/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Switchboard Service
  switchboard-service:
    build:
      context: ./switchboard-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=switchboard-solana-mainnet
      - CHAIN=solana
      - RPC_URL=${SOLANA_RPC_URL}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=BTC/USD,ETH/USD,SOL/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Flux Service
  flux-service:
    build:
      context: ./flux-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=flux-near-mainnet
      - CHAIN=near
      - RPC_URL=${NEAR_RPC_URL}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=NEAR/USD,BTC/USD,ETH/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # DIA Service
  dia-service:
    build:
      context: ./dia-service
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - INSTANCE_ID=dia-ethereum-mainnet
      - CHAIN=ethereum
      - RPC_URL=${ETHEREUM_RPC_URL}
      - SYNC_INTERVAL_MS=60000
      - SYMBOLS=ETH/USD,BTC/USD,DIADATA/USD
    depends_on:
      redis:
        condition: service_healthy
    restart: unless-stopped

  # Service Orchestrator
  orchestrator:
    build:
      context: ./orchestrator
      dockerfile: Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - NODE_ENV=production
    ports:
      - "8080:8080"
    depends_on:
      - redis
      - chainlink-service
      - pyth-service
    restart: unless-stopped

volumes:
  redis_data:
